{% extends 'base.html' %}
{% block content %}
<div class="card">
  <h1>ðŸ§© Sudoku</h1>
  <div class="small">Theme: <span id="theme-name">Dark</span> â€¢ Hints left: <span id="hints-left">3</span> â€¢ Time: <span id="timer">0</span>s</div>
  <div style="margin:12px 0">
    Difficulty: 
    <select id="difficulty">
      <option value="easy">Easy</option>
      <option value="medium" selected>Medium</option>
      <option value="hard">Hard</option>
    </select>
    <button class="btn" onclick="newPuzzle()">New Puzzle</button>
    <button class="btn secondary" onclick="getHint()">Get Hint</button>
    <button class="btn danger" onclick="restart()">Restart</button>
  </div>
  <div id="board" class="sudoku-container"></div>
  <div class="controls">
    <button class="btn" onclick="setDigit(1)">1</button>
    <button class="btn" onclick="setDigit(2)">2</button>
    <button class="btn" onclick="setDigit(3)">3</button>
    <button class="btn" onclick="setDigit(4)">4</button>
    <button class="btn" onclick="setDigit(5)">5</button>
    <button class="btn" onclick="setDigit(6)">6</button>
    <button class="btn" onclick="setDigit(7)">7</button>
    <button class="btn" onclick="setDigit(8)">8</button>
    <button class="btn" onclick="setDigit(9)">9</button>
    <button class="btn secondary" onclick="erase()">Erase</button>
  </div>
  <p class="small">Click on a cell and use number keys (1-9) or buttons above</p>
  <p class="small">"Sudoku powered by Harsha Enterprises"</p>
  <a class="btn secondary" href="/dashboard">Back to Dashboard</a>
</div>
{% endblock %}

{% block scripts %}
<script>
let puzzle = [];
let solution = [];
let selected = null;
let startTime = null;
let timerInterval = null;
let hintsLeft = 3;
let original = [];

function $(id){ return document.getElementById(id); }

function makeCell(r,c,val,prefilled){
  const d = document.createElement('div');
  d.className = 'cell' + (prefilled ? ' prefilled' : '');
  d.dataset.r = r; d.dataset.c = c;
  d.textContent = val ? val : '';
  d.onclick = () => { 
    if(!prefilled){ 
      if(selected) selected.style.outline='none'; 
      selected = d; 
      d.style.outline='2px solid var(--accent)'; 
    } 
  };
  return d;
}

function drawBoard(){
  const board = $('board');
  board.innerHTML = '';
  
  for (let boxRow = 0; boxRow < 3; boxRow++) {
    for (let boxCol = 0; boxCol < 3; boxCol++) {
      const box = document.createElement('div');
      box.className = 'sudoku-box';
      
      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 3; c++) {
          const cellRow = boxRow * 3 + r;
          const cellCol = boxCol * 3 + c;
          const cell = makeCell(cellRow, cellCol, puzzle[cellRow][cellCol], original[cellRow][cellCol] !== 0);
          box.appendChild(cell);
        }
      }
      
      board.appendChild(box);
    }
  }
}

async function newPuzzle(){
  hintsLeft = 3; 
  $('hints-left').textContent = hintsLeft;
  const diff = $('difficulty').value;
  
  try {
    const resp = await fetch('/api/new_puzzle?difficulty=' + diff);
    const data = await resp.json();
    
    if (data.error) {
      alert(data.error);
      return;
    }
    
    puzzle = data.puzzle;
    solution = data.solution;
    original = JSON.parse(JSON.stringify(puzzle));
    
    startTimer();
    drawBoard();
  } catch (error) {
    console.error('Error loading puzzle:', error);
    alert('Failed to load puzzle. Please try again.');
  }
}

function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  startTime = Date.now();
  timerInterval = setInterval(() => {
    $('timer').textContent = Math.floor((Date.now() - startTime)/1000);
  }, 1000);
}

function setDigit(n){
  if(!selected) {
    alert('Please select a cell first');
    return;
  }
  
  const r = parseInt(selected.dataset.r);
  const c = parseInt(selected.dataset.c);
  
  if(original[r][c] !== 0) {
    alert('Cannot change pre-filled numbers');
    return;
  }
  
  selected.textContent = n;
  puzzle[r][c] = n;
  validateCell(selected, r, c);
  checkSolved();
}

function erase(){
  if(!selected) {
    alert('Please select a cell first');
    return;
  }
  
  const r = parseInt(selected.dataset.r);
  const c = parseInt(selected.dataset.c);
  
  if(original[r][c] !== 0) {
    alert('Cannot erase pre-filled numbers');
    return;
  }
  
  selected.textContent = '';
  selected.classList.remove('error');
  puzzle[r][c] = 0;
}

function validateCell(cell, r, c){
  if(puzzle[r][c] === 0){ 
    cell.classList.remove('error'); 
    return; 
  }
  
  if(puzzle[r][c] !== solution[r][c]){
    cell.classList.add('error');
  } else {
    cell.classList.remove('error');
  }
}

function isSolved(){
  for(let r=0; r<9; r++){
    for(let c=0; c<9; c++){
      if(puzzle[r][c] !== solution[r][c]) return false;
    }
  }
  return true;
}

async function checkSolved(){
  if(isSolved()){
    clearInterval(timerInterval);
    const seconds = Math.floor((Date.now() - startTime)/1000);
    
    if({{ 'true' if session.guest else 'false' }}){
      alert('ðŸŽ‰ Solved in ' + seconds + ' seconds! (Guest mode - score not saved)');
    } else {
      alert('ðŸŽ‰ Solved in ' + seconds + ' seconds! Posting to leaderboard...');
      
      try {
        const res = await fetch('/api/record_result', {
          method: 'POST', 
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({seconds})
        });
        
        const j = await res.json();
        if(j.status === 'ok'){
          alert('Result recorded! Your best: ' + j.best_time + 's. Rank: #' + j.rank);
          window.location.href = '/leaderboard';
        } else {
          alert('Result not recorded: ' + (j.error || 'Unknown error'));
        }
      } catch(e) {
        console.error(e);
        alert('Failed to post result.');
      }
    }
  }
}

async function getHint(){
  if(hintsLeft <= 0){ 
    alert('No hints left.'); 
    return; 
  }
  
  try {
    const res = await fetch('/api/hint', {method: 'POST'});
    const j = await res.json();
    
    if(j.error){ 
      alert(j.error); 
      return; 
    }
    
    const {r, c, val, hints_left} = j;
    const board = $('board');
    const boxes = board.getElementsByClassName('sudoku-box');
    const boxRow = Math.floor(r / 3);
    const boxCol = Math.floor(c / 3);
    const cellRow = r % 3;
    const cellCol = c % 3;
    const box = boxes[boxRow * 3 + boxCol];
    const cell = box.children[cellRow * 3 + cellCol];
    
    puzzle[r][c] = val;
    original[r][c] = val;
    cell.textContent = val;
    cell.classList.add('prefilled');
    hintsLeft = hints_left;
    $('hints-left').textContent = hintsLeft;
    
    checkSolved();
  } catch (error) {
    console.error('Error getting hint:', error);
    alert('Failed to get hint. Please try again.');
  }
}

function restart(){
  puzzle = JSON.parse(JSON.stringify(original));
  drawBoard();
  startTimer();
}

// Keyboard support
document.addEventListener('keydown', (e) => {
  if (e.key >= '1' && e.key <= '9') {
    setDigit(parseInt(e.key));
  } else if (e.key === 'Backspace' || e.key === 'Delete' || e.key === '0') {
    erase();
  }
});

// Initialize game
window.addEventListener('DOMContentLoaded', () => {
  newPuzzle();
  const isLight = document.documentElement.classList.contains('light');
  document.getElementById('theme-name').textContent = isLight ? 'Light' : 'Dark';
});
</script>
{% endblock %}
