
{% extends "base.html" %}
{% block content %}
<h2>Play ({{ difficulty|capitalize }})</h2>
<article class="card">
  <div class="sudoku">
    {% for r in range(9) %}
      {% for c in range(9) %}
        {% set val = puzzle[r][c] %}
        {% if val == 0 %}
          <input maxlength="1" data-r="{{r}}" data-c="{{c}}">
        {% else %}
          <input maxlength="1" value="{{ val }}" disabled>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
  <p>
    <button id="check">Check</button>
    <button id="reset">Reset</button>
    <select id="difficulty">
      <option value="easy" {% if difficulty=="easy" %}selected{% endif %}>Easy</option>
      <option value="medium" {% if difficulty=="medium" %}selected{% endif %}>Medium</option>
      <option value="hard" {% if difficulty=="hard" %}selected{% endif %}>Hard</option>
    </select>
    <a href="{{ url_for('play') }}?difficulty=" id="go" role="button" class="secondary">New</a>
  </p>
  <p id="status"></p>
</article>
<script>
const sol = {{ solution|tojson }};
const puzzle = {{ puzzle|tojson }};
const diffSel = document.getElementById('difficulty');
const go = document.getElementById('go');
diffSel.addEventListener('change', () => { go.href = "{{ url_for('play') }}?difficulty=" + diffSel.value; });

document.getElementById('reset').onclick = () => {
  document.querySelectorAll('.sudoku input').forEach((el, idx) => {
    const r = Math.floor(idx/9), c = idx%9;
    if (puzzle[r][c] === 0) el.value = '';
  });
};

document.getElementById('check').onclick = async () => {
  let ok = true;
  document.querySelectorAll('.sudoku input').forEach((el, idx) => {
    const r = Math.floor(idx/9), c = idx%9;
    const v = parseInt(el.value||'0',10);
    if (puzzle[r][c] === 0 && v !== sol[r][c]) ok = false;
  });
  const st = document.getElementById('status');
  if (ok) {
    st.textContent = "Congrats! Recording your time...";
    const seconds = Math.floor((performance.now())/1000); // naive
    try {
      const form = new FormData();
      form.append('seconds', seconds);
      form.append('difficulty', '{{ difficulty }}');
      const res = await fetch('{{ url_for("record_result") }}', { method: 'POST', body: form });
      const j = await res.json();
      if (j.status === 'ok') st.textContent = "Saved! Best: " + j.best + "s Â· Rank: " + j.rank;
      else st.textContent = "Saved locally (not logged in).";
    } catch(e) { st.textContent = "Saved locally."; }
  } else {
    st.textContent = "Some cells are incorrect. Keep trying.";
  }
};
</script>
{% endblock %}
